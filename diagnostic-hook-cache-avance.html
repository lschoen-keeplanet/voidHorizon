<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Avanc√© - Hook Cach√© voidHorizon</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .critical-section {
            background: #fed7d7;
            border: 2px solid #f56565;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .critical-section h3 {
            color: #c53030;
            margin-top: 0;
        }
        
        .diagnostic-section {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .diagnostic-section h3 {
            color: #c53030;
            margin-top: 0;
        }
        
        .solution-section {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .solution-section h3 {
            color: #22543d;
            margin-top: 0;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .button:hover {
            background: #c0392b;
        }
        
        .button.success {
            background: #27ae60;
        }
        
        .button.success:hover {
            background: #229954;
        }
        
        .button.warning {
            background: #f39c12;
        }
        
        .button.warning:hover {
            background: #e67e22;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .status.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
        }
        
        .status.success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }
        
        .status.info {
            background: #bee3f8;
            border: 1px solid #90cdf4;
            color: #2a4365;
        }
        
        .status.warning {
            background: #fef5e7;
            border: 1px solid #fbd38d;
            color: #c05621;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Diagnostic Avanc√© - Hook Cach√© voidHorizon</h1>
        
        <div class="critical-section">
            <h3>üö® PROBL√àME CRITIQUE IDENTIFI√â</h3>
            <p><strong>Erreur persistante :</strong> <code>main.js:721:69</code></p>
            <p><strong>Cause :</strong> Hook cach√© dans un fichier non d√©tect√© qui cause l'erreur</p>
            <p><strong>Notre hook :</strong> Fonctionne parfaitement (SettingsConfig d√©tect√©)</p>
        </div>
        
        <div class="diagnostic-section">
            <h3>üîç Diagnostic Avanc√©</h3>
            <p>Il y a un <strong>hook cach√©</strong> quelque part qui cause l'erreur. Notre hook l'intercepte mais ne peut pas l'emp√™cher.</p>
            
            <button class="button" onclick="scanAllHooksAdvanced()">üîç Scanner Tous les Hooks Avanc√©</button>
            <button class="button warning" onclick="findHiddenHook()">üö® Chercher Hook Cach√©</button>
            <button class="button success" onclick="checkSystemFiles()">üìÅ V√©rifier Fichiers Syst√®me</button>
            <button class="button" onclick="clearResults()">üóëÔ∏è Effacer R√©sultats</button>
        </div>
        
        <div class="solution-section">
            <h3>üõ†Ô∏è Solutions Possibles</h3>
            <ol>
                <li><strong>Hook cach√©</strong> dans un fichier syst√®me</li>
                <li><strong>Module externe</strong> qui interf√®re</li>
                <li><strong>Fichier main.js</strong> corrompu ou modifi√©</li>
                <li><strong>Conflit de versions</strong> Foundry VTT</li>
            </ol>
        </div>
        
        <div class="solution-section">
            <h3>üìã Instructions de Diagnostic Avanc√©</h3>
            <ol>
                <li><strong>Ouvrez Foundry VTT</strong> avec le syst√®me voidHorizon</li>
                <li><strong>Ouvrez la console</strong> (F12)</li>
                <li><strong>Cliquez sur "Chercher Hook Cach√©"</strong></li>
                <li><strong>Notez TOUS les r√©sultats</strong> dans la console</li>
                <li><strong>V√©rifiez les erreurs</strong> qui apparaissent</li>
            </ol>
        </div>
        
        <div id="resultsContainer">
            <div class="status info">
                üí° Cliquez sur "Chercher Hook Cach√©" pour identifier la source exacte du probl√®me
            </div>
        </div>
    </div>

    <script>
        // Scanner tous les hooks de mani√®re avanc√©e
        function scanAllHooksAdvanced() {
            const resultsContainer = document.getElementById('resultsContainer');
            const status = document.createElement('div');
            status.className = 'status info';
            
            if (typeof game !== 'undefined' && game.settings) {
                status.innerHTML = `
                    <strong>üîç Diagnostic avanc√© en cours...</strong><br>
                    V√©rifiez la console pour les r√©sultats d√©taill√©s.
                `;
                
                console.log('üîç === DIAGNOSTIC AVANC√â DES HOOKS ===');
                console.log('üéÆ Version Foundry VTT:', game.version);
                console.log('üîß Syst√®me actuel:', game.system.id);
                console.log('üì¶ Modules actifs:', Array.from(game.modules.keys()));
                
                // V√©rifier les hooks enregistr√©s de mani√®re d√©taill√©e
                if (Hooks && Hooks.events) {
                    console.log('üìã Tous les hooks enregistr√©s:');
                    
                    Object.keys(Hooks.events).forEach(hookName => {
                        const hooks = Hooks.events[hookName];
                        console.log(`  üîó ${hookName}: ${hooks.length} fonctions`);
                        
                        hooks.forEach((hook, index) => {
                            console.log(`    üìÑ Hook ${index}:`, hook);
                            if (hook.fn) {
                                const fnStr = hook.fn.toString();
                                console.log(`    üìù Source (100 premiers caract√®res):`, fnStr.substring(0, 100) + '...');
                                
                                // Chercher des indices dans le code
                                if (fnStr.includes('type')) {
                                    console.log(`    üîç Contient 'type': OUI`);
                                }
                                if (fnStr.includes('voidHorizon')) {
                                    console.log(`    üîç Contient 'voidHorizon': OUI`);
                                }
                                if (fnStr.includes('main.js')) {
                                    console.log(`    üö® Contient 'main.js': OUI - POTENTIELLEMENT PROBL√âMATIQUE`);
                                }
                            }
                        });
                    });
                }
                
                console.log('üîç === FIN DU DIAGNOSTIC AVANC√â ===');
                
            } else {
                status.className = 'status error';
                status.innerHTML = `
                    <strong>‚ùå Erreur</strong><br>
                    Vous devez √™tre dans Foundry VTT pour ce diagnostic.
                `;
            }
            
            resultsContainer.appendChild(status);
        }
        
        // Chercher sp√©cifiquement le hook cach√©
        function findHiddenHook() {
            const resultsContainer = document.getElementById('resultsContainer');
            const status = document.createElement('div');
            
            if (typeof game !== 'undefined') {
                status.className = 'status warning';
                status.innerHTML = `
                    <strong>üö® Recherche du Hook Cach√©</strong><br>
                    V√©rifiez la console pour l'analyse d√©taill√©e.
                `;
                
                console.log('üö® === RECHERCHE DU HOOK CACH√â ===');
                
                // V√©rifier sp√©cifiquement le hook probl√©matique
                if (Hooks.events.getHeaderControlsApplicationV2) {
                    console.log('üîç Hook getHeaderControlsApplicationV2 trouv√©:');
                    
                    Hooks.events.getHeaderControlsApplicationV2.forEach((hook, index) => {
                        console.log(`  üìÑ Hook ${index}:`, hook);
                        
                        if (hook.fn) {
                            const fnStr = hook.fn.toString();
                            console.log(`  üìù Fonction compl√®te:`, fnStr);
                            
                            // Analyser la fonction pour trouver des indices
                            if (fnStr.includes('main.js')) {
                                console.log('üö® ATTENTION: Cette fonction contient une r√©f√©rence √† main.js !');
                            }
                            
                            if (fnStr.includes('app.type')) {
                                console.log('üö® ATTENTION: Cette fonction acc√®de √† app.type !');
                            }
                            
                            if (fnStr.includes('Cannot read properties')) {
                                console.log('üö® ATTENTION: Cette fonction contient le message d\'erreur !');
                            }
                        }
                    });
                } else {
                    console.log('‚ùå Hook getHeaderControlsApplicationV2 non trouv√©');
                }
                
                // V√©rifier les autres hooks qui pourraient interf√©rer
                const suspiciousHooks = ['renderApplication', 'renderSettingsConfig', 'getApplicationHeaderButtons'];
                suspiciousHooks.forEach(hookName => {
                    if (Hooks.events[hookName]) {
                        console.log(`üîç Hook suspect ${hookName}:`, Hooks.events[hookName]);
                    }
                });
                
                console.log('üö® === FIN DE LA RECHERCHE ===');
                
            } else {
                status.className = 'status error';
                status.innerHTML = `
                    <strong>‚ùå Foundry VTT non d√©tect√©</strong><br>
                    Vous devez √™tre dans Foundry VTT pour ce test.
                `;
            }
            
            resultsContainer.appendChild(status);
        }
        
        // V√©rifier les fichiers syst√®me
        function checkSystemFiles() {
            const resultsContainer = document.getElementById('resultsContainer');
            const status = document.createElement('div');
            
            if (typeof game !== 'undefined') {
                status.className = 'status info';
                status.innerHTML = `
                    <strong>üìÅ V√©rification des Fichiers Syst√®me</strong><br>
                    V√©rifiez la console pour l'analyse.
                `;
                
                console.log('üìÅ === V√âRIFICATION DES FICHIERS SYST√àME ===');
                
                // V√©rifier la structure du syst√®me
                console.log('üîß Syst√®me:', game.system);
                console.log('üì¶ Packs syst√®me:', game.packs);
                console.log('üé≠ Types d\'acteurs:', game.system.documentTypes?.Actor);
                console.log('üìÑ Types d\'objets:', game.system.documentTypes?.Item);
                
                // V√©rifier les modules actifs
                console.log('üì¶ Modules actifs:');
                Array.from(game.modules.entries()).forEach(([key, module]) => {
                    console.log(`  üîó ${key}: ${module.title} (${module.version})`);
                });
                
                // V√©rifier les conflits potentiels
                if (game.modules.has('voidHorizon')) {
                    console.log('‚ö†Ô∏è ATTENTION: Module voidHorizon trouv√© - conflit potentiel !');
                }
                
                console.log('üìÅ === FIN DE LA V√âRIFICATION ===');
                
            } else {
                status.className = 'status error';
                status.innerHTML = `
                    <strong>‚ùå Foundry VTT non d√©tect√©</strong><br>
                    Vous devez √™tre dans Foundry VTT pour ce test.
                `;
            }
            
            resultsContainer.appendChild(status);
        }
        
        // Effacer les r√©sultats
        function clearResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const statuses = resultsContainer.querySelectorAll('.status:not(:first-child)');
            statuses.forEach(status => status.remove());
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üö® Diagnostic avanc√© des hooks cach√©s voidHorizon charg√©');
            
            // V√©rifier si on est dans Foundry VTT
            if (typeof game !== 'undefined') {
                console.log('üéÆ Foundry VTT d√©tect√©');
                console.log('üîß Syst√®me:', game.system?.id);
            } else {
                console.log('üåê Test en mode navigateur (hors Foundry VTT)');
            }
        });
    </script>
</body>
</html>
