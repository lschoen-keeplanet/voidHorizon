import BaseSetting from"../../../common/documents/setting.mjs";import ServerDocumentMixin from"../backend/server-document.mjs";import{USER_PERMISSIONS,USER_ROLES}from"../../../common/constants.mjs";export default class Setting extends(ServerDocumentMixin(BaseSetting)){async _preUpdate(e,t,i){"core.moduleConfiguration"===this.key&&"value"in e&&game.world&&this.#e(e,t,i)}async _onCreate(e,t,i){await this.#t(),"core.moduleConfiguration"===this.key&&await game.world.onUpdateModuleConfiguration(this.value)}async _onUpdate(e,t,i){await this.#t(),"core.moduleConfiguration"===this.key&&await game.world.onUpdateModuleConfiguration(this.value)}async#t(){switch(this.key){case"core.permissions":game.permissions=this.value;break;case"core.compendiumConfiguration":game.compendiumConfiguration=this.value;break;case"core.time":game.activity.worldTime=parseInt(this.value)}}#e(e,t,i){const a=Array.from(game.world.relationships.requires).concat(Array.from(game.world.system.relationships.requires)),s=JSON.parse(e.value);for(const e of Object.keys(s)){const t=game.world.modules.get(e);if(!t)continue;const i=t.isCompatibleWithSystem(game.world.system),o=a.find((t=>t.id===e));i&&o?s[e]=!0:i||(s[e]=!1)}this.updateSource({value:JSON.stringify(s)},t)}static async getValue(e){const t=await this.sublevel.findOne({key:e});return t?JSON.parse(t.value):null}static async set(e,t){t="string"==typeof t?t:JSON.stringify(t);let i=await this.find({key:e});if(i.length){i=i.shift();const e=await i.update({value:t});i.updateSource(e)}else i=await this.create({key:e,value:t});return i}static async getPermissions(){let e=await this.getValue("core.permissions")||{},t=!1;for(let[i,a]of Object.entries(USER_PERMISSIONS))i in e||(e[i]=Object.values(USER_ROLES).reduce(((e,t)=>(a.defaultRole<=t&&e.push(t),e)),[]),t=!0);return t&&await this.set("core.permissions",e),game.permissions=e}static async advanceTime(e,{user:t}={}){const i=await this.getValue("core.time")??0,a=await this.set("core.time",i+e);return global.express.io.emit("modifyDocument",{request:{type:"Setting",action:"update",options:{render:!1}},result:[{_id:a.id,value:a.value}],userId:t?.id}),a}}