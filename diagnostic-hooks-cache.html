<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic - Hook getHeaderControlsApplicationV2</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .diagnostic-section {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .diagnostic-section h3 {
            color: #c53030;
            margin-top: 0;
        }
        
        .solution-section {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .solution-section h3 {
            color: #22543d;
            margin-top: 0;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .button:hover {
            background: #c0392b;
        }
        
        .button.success {
            background: #27ae60;
        }
        
        .button.success:hover {
            background: #229954;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .status.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
        }
        
        .status.success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }
        
        .status.info {
            background: #bee3f8;
            border: 1px solid #90cdf4;
            color: #2a4365;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic - Hook getHeaderControlsApplicationV2</h1>
        
        <div class="diagnostic-section">
            <h3>üö® Probl√®me Persistant</h3>
            <p><strong>Erreur :</strong> <code>getHeaderControlsApplicationV2: Cannot read properties of undefined (reading 'type')</code></p>
            <p><strong>Cause :</strong> Hook cach√© qui n'a pas √©t√© identifi√© dans notre recherche pr√©c√©dente.</p>
        </div>
        
        <div class="diagnostic-section">
            <h3>üîç Diagnostic Avanc√©</h3>
            <p>Ce fichier va nous aider √† identifier la source exacte du hook probl√©matique.</p>
            
            <button class="button" onclick="scanAllHooks()">üîç Scanner Tous les Hooks</button>
            <button class="button success" onclick="checkFoundryHooks()">üéÆ V√©rifier Hooks Foundry</button>
            <button class="button" onclick="clearResults()">üóëÔ∏è Effacer R√©sultats</button>
        </div>
        
        <div class="solution-section">
            <h3>üõ†Ô∏è Solutions Possibles</h3>
            <ol>
                <li><strong>Hook cach√©</strong> dans un fichier non d√©tect√©</li>
                <li><strong>Module externe</strong> qui interf√®re</li>
                <li><strong>Version Foundry VTT</strong> incompatible</li>
                <li><strong>Conflit de modules</strong> avec d'autres syst√®mes</li>
            </ol>
        </div>
        
        <div class="solution-section">
            <h3>üìã Instructions de Diagnostic</h3>
            <ol>
                <li><strong>Ouvrez Foundry VTT</strong> avec le syst√®me voidHorizon</li>
                <li><strong>Ouvrez la console</strong> (F12)</li>
                <li><strong>Cliquez sur "Scanner Tous les Hooks"</strong></li>
                <li><strong>Notez les r√©sultats</strong> dans la console</li>
                <li><strong>V√©rifiez les erreurs</strong> qui apparaissent</li>
            </ol>
        </div>
        
        <div id="resultsContainer">
            <div class="status info">
                üí° Cliquez sur "Scanner Tous les Hooks" pour commencer le diagnostic
            </div>
        </div>
    </div>

    <script>
        // Scanner tous les hooks disponibles
        function scanAllHooks() {
            const resultsContainer = document.getElementById('resultsContainer');
            const status = document.createElement('div');
            status.className = 'status info';
            
            if (typeof game !== 'undefined' && game.settings) {
                status.innerHTML = `
                    <strong>üîç Diagnostic en cours...</strong><br>
                    V√©rifiez la console pour les r√©sultats d√©taill√©s.
                `;
                
                // Scanner les hooks Foundry VTT
                console.log('üîç === DIAGNOSTIC DES HOOKS ===');
                console.log('üéÆ Version Foundry VTT:', game.version);
                console.log('üîß Syst√®me actuel:', game.system.id);
                console.log('üì¶ Modules actifs:', Array.from(game.modules.keys()));
                
                // V√©rifier les hooks enregistr√©s
                if (Hooks && Hooks.events) {
                    console.log('üìã Hooks enregistr√©s:', Object.keys(Hooks.events));
                    
                    // Chercher sp√©cifiquement le hook probl√©matique
                    if (Hooks.events.getHeaderControlsApplicationV2) {
                        console.log('üö® HOOK PROBL√âMATIQUE TROUV√â !');
                        console.log('üìù D√©tails:', Hooks.events.getHeaderControlsApplicationV2);
                        
                        // Analyser les fonctions enregistr√©es
                        Hooks.events.getHeaderControlsApplicationV2.forEach((hook, index) => {
                            console.log(`üîç Hook ${index}:`, hook);
                            if (hook.fn) {
                                console.log(`üìÑ Source:`, hook.fn.toString().substring(0, 200) + '...');
                            }
                        });
                    } else {
                        console.log('‚úÖ Hook getHeaderControlsApplicationV2 non trouv√© dans Hooks.events');
                    }
                }
                
                // V√©rifier les param√®tres
                console.log('‚öôÔ∏è Param√®tres syst√®me:', Object.keys(game.settings.settings));
                console.log('üéõÔ∏è Param√®tres voidHorizon:', Object.keys(game.settings.settings).filter(key => key.startsWith('voidHorizon')));
                
                // V√©rifier les feuilles enregistr√©es
                console.log('üìÑ Feuilles d\'acteurs:', Array.from(game.actors.entries()).map(([id, actor]) => actor.sheet.constructor.name));
                console.log('üìÑ Feuilles d\'objets:', Array.from(game.items.entries()).map(([id, item]) => item.sheet.constructor.name));
                
                console.log('üîç === FIN DU DIAGNOSTIC ===');
                
            } else {
                status.className = 'status error';
                status.innerHTML = `
                    <strong>‚ùå Erreur</strong><br>
                    Vous devez √™tre dans Foundry VTT pour ce diagnostic.
                `;
            }
            
            resultsContainer.appendChild(status);
        }
        
        // V√©rifier les hooks Foundry VTT
        function checkFoundryHooks() {
            const resultsContainer = document.getElementById('resultsContainer');
            const status = document.createElement('div');
            
            if (typeof game !== 'undefined') {
                status.className = 'status success';
                status.innerHTML = `
                    <strong>‚úÖ Foundry VTT D√©tect√©</strong><br>
                    <strong>Version:</strong> ${game.version}<br>
                    <strong>Syst√®me:</strong> ${game.system.id}<br>
                    <strong>Modules:</strong> ${Array.from(game.modules.keys()).length}<br>
                    V√©rifiez la console pour plus de d√©tails.
                `;
                
                // V√©rifier les hooks sp√©cifiques
                console.log('üîç === V√âRIFICATION DES HOOKS FOUNDRY ===');
                
                // Lister tous les hooks disponibles
                const availableHooks = [
                    'init', 'setup', 'ready', 'i18nInit',
                    'renderChatMessage', 'getChatLogEntryContext',
                    'renderChatLog', 'renderChatPopout',
                    'getActorDirectoryEntryContext',
                    'canvasInit', 'hotbarDrop',
                    'getHeaderControlsApplicationV2' // Hook probl√©matique
                ];
                
                availableHooks.forEach(hookName => {
                    if (Hooks.events[hookName]) {
                        console.log(`‚úÖ Hook ${hookName}: ${Hooks.events[hookName].length} fonctions enregistr√©es`);
                        
                        if (hookName === 'getHeaderControlsApplicationV2') {
                            console.log('üö® ANALYSE DU HOOK PROBL√âMATIQUE:');
                            Hooks.events[hookName].forEach((hook, index) => {
                                console.log(`  üìÑ Hook ${index}:`, hook);
                                if (hook.fn) {
                                    const fnStr = hook.fn.toString();
                                    console.log(`  üìù Source (200 premiers caract√®res):`, fnStr.substring(0, 200) + '...');
                                    
                                    // Chercher des indices dans le code
                                    if (fnStr.includes('type')) {
                                        console.log(`  üîç Contient 'type': OUI`);
                                    }
                                    if (fnStr.includes('voidHorizon')) {
                                        console.log(`  üîç Contient 'voidHorizon': OUI`);
                                    }
                                }
                            });
                        }
                    } else {
                        console.log(`‚ùå Hook ${hookName}: Non enregistr√©`);
                    }
                });
                
                console.log('üîç === FIN DE LA V√âRIFICATION ===');
                
            } else {
                status.className = 'status error';
                status.innerHTML = `
                    <strong>‚ùå Foundry VTT non d√©tect√©</strong><br>
                    Vous devez √™tre dans Foundry VTT pour ce test.
                `;
            }
            
            resultsContainer.appendChild(status);
        }
        
        // Effacer les r√©sultats
        function clearResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const statuses = resultsContainer.querySelectorAll('.status:not(:first-child)');
            statuses.forEach(status => status.remove());
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Diagnostic des hooks voidHorizon charg√©');
            
            // V√©rifier si on est dans Foundry VTT
            if (typeof game !== 'undefined') {
                console.log('üéÆ Foundry VTT d√©tect√©');
                console.log('üîß Syst√®me:', game.system?.id);
            } else {
                console.log('üåê Test en mode navigateur (hors Foundry VTT)');
            }
        });
    </script>
</body>
</html>
